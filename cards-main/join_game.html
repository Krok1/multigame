<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –≥—Ä–∏ - BlackJack</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">üÉè BlackJack</h1>
            <div class="game-info">–ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –≥—Ä–∏</div>
        </div>

        <div id="joinContent" class="loading">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
        </div>
    </div>

    <script>
        const chatId = {{ chat_id }};
        let gameJoined = false;
        let tgWebApp = null;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        document.addEventListener('DOMContentLoaded', function() {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Telegram WebApp —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π
            if (window.Telegram && window.Telegram.WebApp) {
                tgWebApp = window.Telegram.WebApp;
                tgWebApp.ready();
                tgWebApp.expand();
            }
            
            loadGameInfo();
        });

        async function loadGameInfo() {
            try {
                console.log(`Loading session info for chat_id: ${chatId}`);
                const response = await fetch(`/api/sessions/${chatId}`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    console.error('Response not ok:', response.status, response.statusText);
                    showError(`–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                    return;
                }
                
                const data = await response.json();
                console.log('Session data:', data);
                
                if (data.error) {
                    console.error('API error:', data.error);
                    showError(`–°–µ—Å—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞: ${data.error}`);
                    return;
                }
                
                if (!data.session) {
                    console.error('No session in response');
                    showError('–ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞: –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö —Å–µ—Å—ñ—ó');
                    return;
                }
                
                const session = data.session;
                displaySessionInfo(session);
            } catch (error) {
                console.error('Load session error:', error);
                showError(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}`);
            }
        }

        function displaySessionInfo(session) {
            if (session.status === 'closed') {
                // –°–µ—Å—ñ—è –∑–∞–∫—Ä–∏—Ç–∞
                document.getElementById('joinContent').innerHTML = `
                    <div class="status-message error">
                        <h3>‚ùå –°–µ—Å—ñ—è –∑–∞–∫—Ä–∏—Ç–∞</h3>
                        <p>–¶—è —ñ–≥—Ä–æ–≤–∞ —Å–µ—Å—ñ—è –±—É–ª–∞ –∑–∞–∫—Ä–∏—Ç–∞.</p>
                        <p><strong>–°—Ç–≤–æ—Ä–∏–≤:</strong> ${session.creator_username}</p>
                        <p><strong>–ó–∞–∫—Ä–∏—Ç–∞:</strong> ${new Date(session.finished_at).toLocaleString('uk-UA')}</p>
                    </div>
                    
                    <div class="controls">
                        <button class="btn btn-secondary" onclick="goBack()">
                            üîô –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è
                        </button>
                    </div>
                `;
                return;
            }

            if (session.player2_id) {
                // –°–µ—Å—ñ—è –≤–∂–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞
                document.getElementById('joinContent').innerHTML = `
                    <div class="status-message error">
                        <h3>‚ùå –°–µ—Å—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                        <p>–¶—è —Å–µ—Å—ñ—è –≤–∂–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞ –∞–±–æ –≥—Ä–∞ —Ç—Ä–∏–≤–∞—î.</p>
                        <p><strong>–ì—Ä–∞–≤—Ü—ñ:</strong></p>
                        <p>üë§ ${session.creator_username}</p>
                        <p>üë§ ${session.player2_username}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusText(session.status)}</p>
                    </div>
                    
                    <div class="controls">
                        <button class="btn btn-secondary" onclick="goBack()">
                            üîô –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è
                        </button>
                    </div>
                `;
                return;
            }

            // –ú–æ–∂–Ω–∞ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Å–µ—Å—ñ—ó
            const modeText = session.game_mode === 'test' ? '–¢–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º' : '–†–µ–∂–∏–º –Ω–∞ –≥—Ä–æ—à—ñ';
            const currency = session.game_mode === 'test' ? '–º–æ–Ω–µ—Ç' : 'TON';
            
            document.getElementById('joinContent').innerHTML = `
                <div class="status-message">
                    <h3>üéÆ –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ —Å–µ—Å—ñ—ó</h3>
                    <p><strong>–°—Ç–≤–æ—Ä–∏–≤:</strong> ${session.creator_username}</p>
                    <p><strong>–†–µ–∂–∏–º:</strong> ${modeText}</p>
                    <p><strong>–°—Ç–∞–≤–∫–∞:</strong> ${session.stake} ${currency}</p>
                    <p><strong>–°—Ç–≤–æ—Ä–µ–Ω–∞:</strong> ${new Date(session.created_at).toLocaleString('uk-UA')}</p>
                    <p>–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è –¥–ª—è –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ —Å–µ—Å—ñ—ó:</p>
                </div>
                
                <div class="controls" style="margin-bottom: 20px;">
                    <input type="text" id="usernameInput" placeholder="–í–∞—à–µ —ñ–º'—è" 
                           style="padding: 15px; font-size: 1.1em; border-radius: 10px; border: 2px solid #4CAF50; 
                                  margin-right: 10px; background: rgba(255,255,255,0.1); color: white; width: 200px;">
                    <button class="btn" onclick="joinSession()">
                        ‚úÖ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è
                    </button>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" onclick="goBack()">
                        üîô –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è
                    </button>
                </div>
            `;
            
            // Focus –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥—É
            setTimeout(() => {
                const input = document.getElementById('usernameInput');
                if (input) input.focus();
            }, 100);
        }

        function getStatusText(status) {
            switch(status) {
                case 'waiting': return '‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤';
                case 'playing': return 'üéÆ –ì—Ä–∞ —Ç—Ä–∏–≤–∞—î';
                case 'finished': return '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞';
                case 'closed': return '‚ùå –ó–∞–∫—Ä–∏—Ç–∞';
                default: return status;
            }
        }

        async function joinSession() {
            if (gameJoined) return;
            
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            
            if (!username) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º\'—è');
                usernameInput.focus();
                return;
            }
            
            gameJoined = true;
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            let userData;
            if (tgWebApp && tgWebApp.initDataUnsafe && tgWebApp.initDataUnsafe.user) {
                // Telegram WebApp —Ä–µ–∂–∏–º
                const user = tgWebApp.initDataUnsafe.user;
                userData = {
                    user_id: user.id,
                    username: user.username || user.first_name || username
                };
                console.log('Telegram user data:', userData);
            } else {
                // Demo —Ä–µ–∂–∏–º - –≥–µ–Ω–µ—Ä—É—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π user_id
                userData = {
                    user_id: Math.floor(Math.random() * 1000000) + 100000,
                    username: username
                };
                console.log('Demo mode user data:', userData);
            }
            
            try {
                console.log(`Joining session ${chatId} with data:`, userData);
                
                const response = await fetch(`/api/sessions/${chatId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                console.log('Join response status:', response.status);
                
                if (!response.ok) {
                    gameJoined = false;
                    const errorText = await response.text();
                    console.error('Join response error:', response.status, errorText);
                    alert(`–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                    return;
                }
                
                const data = await response.json();
                console.log('Join response data:', data);
                
                if (data.error) {
                    gameJoined = false;
                    console.error('Join API error:', data.error);
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
                    return;
                }
                
                console.log('Successfully joined session, redirecting...');
                // –£—Å–ø—ñ—à–Ω–æ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ –≥—Ä—É
                window.location.href = `/?chat_id=${chatId}`;
                
            } catch (error) {
                gameJoined = false;
                console.error('Join session error:', error);
                alert(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ —Å–µ—Å—ñ—ó: ${error.message}`);
            }
        }

        function showError(message) {
            document.getElementById('joinContent').innerHTML = `
                <div class="status-message error">
                    <h3>‚ùå –ü–æ–º–∏–ª–∫–∞</h3>
                    <p>${message}</p>
                </div>
                
                <div class="controls">
                    <button class="btn" onclick="loadGameInfo()">
                        üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
                    </button>
                    <button class="btn btn-secondary" onclick="goBack()">
                        üîô –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è
                    </button>
                </div>
            `;
        }

        function goBack() {
            history.back();
        }

        // –û–±—Ä–æ–±–∫–∞ Enter –≤ –ø–æ–ª—ñ –≤–≤–æ–¥—É
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('usernameInput') === document.activeElement) {
                joinSession();
            }
        });
    </script>
</body>
</html>